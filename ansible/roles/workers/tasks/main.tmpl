---
- name: "Install the OS Dependencies"
  apt:
    name: "{{ item }}"
    state: latest
    update_cache: yes
  with_items:
    - "socat" 
    - "conntrack" 
    - "ipset"

- name: "Disable Swap : Current Session & @Boot"
  shell: "sudo swapoff -a && sed -ri '/\sswap\s/s/^#?/#/' /etc/fstab"

- name: "Download Worker Binaries"
  get_url:
    url: "{{ item }}"    
    dest: "~/"
  with_items:
    - "https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.21.0/crictl-v1.21.0-linux-amd64.tar.gz"
    - "https://github.com/opencontainers/runc/releases/download/v1.0.0-rc93/runc.amd64"
    - "https://github.com/containernetworking/plugins/releases/download/v0.9.1/cni-plugins-linux-amd64-v0.9.1.tgz"
    - "https://github.com/containerd/containerd/releases/download/v1.4.4/containerd-1.4.4-linux-amd64.tar.gz"
    - "https://storage.googleapis.com/kubernetes-release/release/v1.21.0/bin/linux/amd64/kubectl"
    - "https://storage.googleapis.com/kubernetes-release/release/v1.21.0/bin/linux/amd64/kube-proxy"
    - "https://storage.googleapis.com/kubernetes-release/release/v1.21.0/bin/linux/amd64/kubelet"

- name: "Create the Installation Directories"
  file:
    path: "{{ item }}"
    state: directory
  with_items:
    - "/etc/cni/net.d" 
    - "/opt/cni/bin" 
    - "/var/lib/kubelet" 
    - "/var/lib/kube-proxy" 
    - "/var/lib/kubernetes" 
    - "/var/run/kubernetes" 
    - "~/containerd"

- name: "Décompression de crictl"
  unarchive:
    src: "~/crictl-v1.21.0-linux-amd64.tar.gz"
    dest: "~/"
    remote_src: yes

- name: "Décompression de containerd"
  unarchive:
    src: "~/containerd-1.4.4-linux-amd64.tar.gz"
    dest: "~/containerd"
    remote_src: yes

- name: "Décompression et Installation de CNI"
  unarchive:
    src: "~/cni-plugins-linux-amd64-v0.9.1.tgz"
    dest: "/opt/cni/bin/"
    remote_src: yes
  become: yes
  become_method: su

- name: "Rename runc"
  copy:
    src: "~/runc.amd64"
    dest: "~/runc"
    remote_src: yes

- name: "Copy worker binaries to exec path"
  copy:
    src: "{{ item }}"
    dest: "/usr/local/bin/"
    remote_src: yes
    mode: '0755'
  with_items:
    - "~/crictl"
    - "~/kubectl"
    - "~/kube-proxy"
    - "~/kubelet runc"
  become: yes
  become_method: su

- name: "Copy containerd binary to bin dir"
  copy:
    src: "~/containerd/bin/"
    dest: "/bin/"
    remote_src: yes
    mode: '0755'
  become: yes
  become_method: su


